# メモ

## Kubernetest(k8s) とは何か

* コンテナ化されたワークロードやサービスを管理するためのポータブルかつ拡張性のあるオープンソースのプラットフォーム

* 簡単にデプロイの歴史
  * 仮想化ができる前の時代のデプロイ
    * 物理サーバー上で複数のアプリケーションを実行させていた
    * 各アプリケーションごとにリソースを制限する方法がなくあるアプリケーションが食いつぶすことで他のアプリケーションのパフォーマンスが低下することがあった
    * 解決するために別々の物理サーバーで動かしたりしたが、リソースを十分に活用できず維持コストもかかり拡大しなかった
  * 仮想化ができるようになった時代のデプロイ
    * 1台物理サーバーのCPU上で複数の仮想マシン(VM)を実行できるようになった
      * VM ... 仮想ハードウェア上でそこにインストールされたOSを含むコンポーネントを実行するマシン
    * このVMごとにアプリケーションを実行することでリソース制限ができ、リソース使用率が向上し、アプリケーションの追加や更新が容易になった
    * また、あるVMに他のVMからのアクセスも制限でき、セキュリティレベルも向上した
  * (now)コンテナ化ができるようになった時代のデプロイ
    * VMと違い、コンテナはアプリケーション間でOSを共有できるVMよりも緩和された分離特性を持っている。ゆえにVMよりも軽量である
    * VMと同様にコンテナもリソース制限やアクセス制限等を行える
    * その他、デプロイ容易性や可搬性など様々な利点がある

* k8sが提供する機能
  * あるコンテナがダウンしたら他のコンテナを起動することでダウンタイムが発生しないようにする
  * コンテナへのトラフィックが多い場合に振り分けを行うことで負荷分散する
  * DNS名または独自のIPアドレスを使ってコンテナを公開できる
  * 選択した外レージシステム(ローカルストレージ...)を自動でマウントできる
  * コンテナのあるべき状態を記述することができ、制御されたスピードで実際の状態をあるべき状態に変更することができる。これによりロールバック(新たな変更を含むコンテナへの切り替え)やロールバック(切り戻し)を行うことができる
  * あるコンテナにおいてどのくらいのCPUやメモリー(RAM)が必要かを設定でき、その通りにリソースを割ける
  * 処理が失敗したコンテナの再起動や入れ替え、ヘルスチェクに応答しないコンテナの強制終了を行う
  * 機密情報を保持し管理する

## k8s のコンポーネント

* k8s をデプロイするとクラスターが展開される
  * クラスター ... コンテナ化されたアプリケーションを実行するノードと呼ばれるワーカーマシンの集合
  * 全てのクラスターには少なくとも1つのワーカーノードがある
* ワーカーノードはアプリケーションのコンポーネントであるPodをホストする
  * Pod ... １番小さくシンプルなk8sのオブジェクト。いくつかのコンテナの集まり。
* マスターノードはクラスター内のワーカーノードとPodを管理する
複数のマスターノードを使用してクラスターにフェイルオーバーと高可用性を提供する
  * フェイルオーバー ... 稼働中のシステムに問題が生じた時に自動で待機状態に切り替える。システムの可用性を高める冗長化の1つ。 逆に手動で切り替えるのはスイッチオーバーという。
* マスターノードはコントロールプレーンにてホスティングされており、コントロールプレーンにて実行される

### コントロールプレーンコンポーネント

* クラスターに関する全体的な決定を行う
* クラスターイベントの検出や応答を行う

(種類)

* kube-apiserver ... Kubernetes APIを外部に提供するコンポーネント
* etcd(エトセディー) ... 一貫性、高可用性のあるキーバリューストア、全てのクラスター情報の保存場所として使用される
* kube-scheduler ... 新規作成Podにノードが割り当てられているかを監視し、ない場合ノードを選択する
* kuber-controller-manager ... 複数のコントローラープロセスを実行する
  * コントローラー ... クラスターの状態をAPIサーバーから取得して監視し、あるべき状態に更新する
    * 種類
      * ノードコントローラー ... ノードダウン時の通知と対応を行う
      * レプリケーションコントローラー ... 指定されたPod数を正しく保つ
      * エンドポイントコントローラー ... エンドポイントオブジェクトを注入する(= Service(後述)とPodを紐付ける)
      * サービスアカウントとトークンコントローラー ... 新規名前空間に対してデフォルトアカウントAPIアクセストークンを作成する
* cloud-controller-manager ... k8sと任意のクラウド環境との連携を行うクラウドプロバイダーを動作させるためのコンポーネント、k8sのコントローラー群を動かす
  * 以下のコントローラーはクラウドプロバイダーへの依存関係を持つ可能性がある
    * ノードコントローラー(前述済み)
    * ルーティングコントローラー ... クラウドインフラでルーティング設定する
    * サービスコントローラー ... クラウドプロバイダーのロードバランサーの作成更新削除を行う

### データプレーンコンポーネント(ノードコンポーネント)

* 全てのノードで実行される
* 稼働中のPodの管理やK8sの実行環境を提供する

(種類)

* kubelet ...各ノードで実行されるエージェント。Podが実行されていることを保証する。k8sが作成指定なコンテナは管理しない。
* kube-proxy ... 各ノードで動作しているネットワークプロキシ。クラスター内部または外部のネットワークセッションからPodのネットワーク通信をかのうにする
* コンテナランタイム ... コンテナの実行を担当するソフトウェア

## Deploymentの作成

* Deploymentとは
  * PodやReplicaSetを管理するためのオブジェクト
    * ReplicaSetとは
      * 常駐型でステートレスなPodに対して使われる管理用オブジェクト
      * PodTemplateと呼ばれるPodのテンプレートをもとにPodを指定された数(レプリカ数)に調整・管理する
      * このオブジェクトによりノードの障害やアプリケーションクラッシュでPodが足りない時になどにPodを追加してくれる
        * => セルフヒーリング
    * 関係性: Deployment -(生成・管理)-> ReplicaSet -(生成・管理)-> Pod
  * ローリングアップデートやロールバックなどのデプロイ管理を行う
  * 基本的にPodを1つ起動するにも単独では起動せず、ReplicaSetなどの管理用のオブジェクトを通して起動する利用する
  * コンテナイメージのバージョンアップ時などに新しい仕様のReplicaSetを作成し、ReplicaSetがPodを順次に新しいものに置き換えていく(ローリングアップデート)
    * ※ レプリカ数のみを変更すルときは新しいReplicaSetを作成せず現在のReplicaSetのレプリカ数を変更する
  * ローリングアップデート後もアップデート前のReplicaSetは一定数保持され、ロールバック時に使用される。

* Deploymentの作成方法
  * `kubectl create deployment <Deploymentの命名>`
    * よく使いそうなオプション
      * `--image=<イメージ名>`
      * `--replicas=<レプリカ数(default: 1)>`
       * `--pors=<ポート番号>`

* その他
  * クラスターイベントの確認 ... `kubectl get events`
  * kubectl設定の確認 ... `kubectl config view`

## Serviceの作成

* 通常Podはk8sクラスター内部のIPアドレスからのみアクセス可能
* コンテナに対してk8sの仮想ネットワークの外部からアクセスするためにはk8sのServiceとしてPodを公開する必要がある
